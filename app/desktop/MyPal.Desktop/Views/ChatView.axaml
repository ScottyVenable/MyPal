<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:MyPal.Desktop.ViewModels"
             mc:Ignorable="d"
             x:Class="MyPal.Desktop.Views.ChatView"
             x:DataType="vm:ChatViewModel">

    <UserControl.Styles>
        <Style Selector="Border.chat-bubble">
            <Setter Property="Padding" Value="18,14"/>
            <Setter Property="Background" Value="#2b304e80"/>
            <Setter Property="BorderBrush" Value="#3b4064"/>
            <Setter Property="BorderThickness" Value="1.5"/>
            <Setter Property="MaxWidth" Value="720"/>
            <Setter Property="BoxShadow" Value="0 12 32 0 #090c2030"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>
        <Style Selector="Border.chat-bubble[Tag=True]">
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#7b68ee" Offset="0"/>
                        <GradientStop Color="#5f4ed4" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="BorderBrush" Value="#806eeb"/>
            <Setter Property="BoxShadow" Value="0 16 40 0 #6d61d850"/>
        </Style>
        <Style Selector="TextBox.chat-input">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.Text.Secondary}"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*,Auto,Auto" RowSpacing="18">
        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
            <Border Width="40" Height="40" CornerRadius="14" Background="#2f2854" BorderBrush="#4b3f81" BorderThickness="1">
                <TextBlock Text="&#xE8BD;"
                           FontFamily="Segoe MDL2 Assets"
                           FontSize="20"
                           Foreground="{StaticResource Brush.Accent.Cyan}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
            </Border>
            <StackPanel Spacing="4">
                <TextBlock Text="Chat" FontSize="22" FontWeight="400" Foreground="{StaticResource Brush.Text.Primary}"/>
                <TextBlock Text="Conversations help MyPal learn and grow." FontSize="13" Foreground="{StaticResource Brush.Text.Tertiary}"/>
            </StackPanel>
        </StackPanel>

        <Border Grid.Row="1"
                CornerRadius="28"
                Background="#202742aa"
                BorderBrush="#2f3657"
                BorderThickness="1.5"
                Padding="24"
                BoxShadow="0 22 72 0 #090c203c">
            <Border CornerRadius="24"
                    BorderBrush="#343c60"
                    BorderThickness="1"
                    Padding="12"
                    Background="#161b31">
                <ScrollViewer x:Name="MessagesScrollViewer">
                    <ItemsControl ItemsSource="{Binding Messages}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Spacing="12"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:ChatMessageViewModel">
                                <Grid ColumnDefinitions="*,Auto,*">
                                    <Border Classes="chat-bubble"
                                            Grid.Column="{Binding IsUser, Converter={StaticResource BooleanToGridColumnConverter}}"
                                            HorizontalAlignment="{Binding IsUser, Converter={StaticResource BooleanToHorizontalAlignmentConverter}}"
                                            Tag="{Binding IsUser}"
                                            CornerRadius="{Binding IsUser, Converter={StaticResource BooleanToCornerRadiusConverter}}">
                                        <StackPanel Spacing="8">
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="{Binding IsUser, Converter={StaticResource BooleanToHorizontalAlignmentConverter}}" Spacing="6">
                                                <TextBlock Text="{Binding Sender}" FontSize="12" Foreground="#a8affe"/>
                                                <TextBlock Text="{Binding DisplayTime}" FontSize="11" Foreground="#8b92c1"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Text}" TextWrapping="Wrap" Foreground="{Binding IsUser, Converter={StaticResource ChatMessageForegroundConverter}}"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Border>

        <Border Grid.Row="2"
                Background="#171d34"
                CornerRadius="18"
                Padding="16"
                IsVisible="{Binding IsAwaitingResponse}">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBlock Text="💭" Foreground="#8b92c1" FontSize="20"/>
                <TextBlock Text="Pal is thinking..." Foreground="#8b92c1" FontSize="14"/>
            </StackPanel>
        </Border>

        <StackPanel Grid.Row="3" Spacing="12">
            <Border Background="#202742"
                    CornerRadius="24"
                    BorderBrush="#2f3657"
                    BorderThickness="1.5"
                    Padding="14">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <TextBox Classes="chat-input"
                             Text="{Binding ComposeText, UpdateSourceTrigger=PropertyChanged}"
                             Watermark="Send a message..."
                             AcceptsReturn="True"
                             MinHeight="68"/>
                    <Button Grid.Column="1"
                            Content="Send"
                            Command="{Binding SendMessageCommand}"
                            Classes="accent"
                            Padding="26,14"/>
                </Grid>
            </Border>
            <Border Background="#33111624"
                    CornerRadius="16"
                    Padding="12"
                    IsVisible="{Binding ErrorMessage, Converter={StaticResource NullToBooleanConverter}}">
                <TextBlock Text="{Binding ErrorMessage}" Foreground="#ff7777"/>
            </Border>
        </StackPanel>
    </Grid>
</UserControl>
