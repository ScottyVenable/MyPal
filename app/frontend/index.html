<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline'; connect-src 'self' http://localhost:3001 ws://localhost:3001; img-src 'self' data:; font-src 'self';" />
  <title>Pal — Evolving AI Companion</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module" src="app.js" defer></script>
</head>
<body>
  <!-- Profile Selection Menu -->
  <div id="profile-menu" class="profile-menu">
    <div class="profile-menu-content">
      <h1 class="profile-title">Welcome to MyPal</h1>
      <p class="profile-subtitle">Choose your Pal or create a new one</p>
      
      <div id="continue-section" class="continue-section hidden">
        <button id="continue-btn" class="btn-primary btn-large" type="button">
          Continue with <span id="continue-name">My Pal</span>
        </button>
      </div>
      
      <div class="profile-actions">
        <button id="new-pal-btn" class="btn-secondary" type="button">+ New Pal</button>
        <button id="load-pal-btn" class="btn-secondary" type="button">Load Pal</button>
      </div>
      
      <div id="profile-cards" class="profile-cards hidden"></div>
    </div>
  </div>
  
  <!-- New Pal Modal -->
  <div id="new-pal-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Create New Pal</h2>
      <form id="new-pal-form">
        <label for="new-pal-name">Pal Name</label>
        <input id="new-pal-name" type="text" placeholder="Enter a name..." maxlength="30" required />
        <div class="form-hint">Maximum 30 characters</div>
        <div id="new-pal-error" class="form-error hidden"></div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary">Create</button>
          <button type="button" id="new-pal-cancel" class="btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Main App (hidden until profile loaded) -->
  <div id="main-app" class="hidden">
  <header>
    <div class="header-left">
      <h1>Pal</h1>
      <span id="current-profile-name" class="profile-badge"></span>
    </div>
    <nav>
      <button type="button" data-tab="chat" class="active">Conversation</button>
      <button type="button" data-tab="stats">Stats</button>
      <button type="button" data-tab="brain">Brain</button>
      <button type="button" data-tab="journal">Journal</button>
      <button type="button" data-tab="settings">Settings</button>
    </nav>
    <button id="exit-to-menu" class="exit-btn" type="button" title="Exit to Profile Menu">⬅ Exit</button>
  </header>

  <main>
    <section id="tab-chat" class="tab active">
      <div class="emotion-display" id="emotion-display">
        <div class="emotion-icon" id="emotion-icon">😊</div>
        <div class="emotion-details">
          <div class="emotion-mood" id="emotion-mood">Pal is calm</div>
          <div class="emotion-bar">
            <div class="emotion-fill" id="emotion-fill" style="width: 50%"></div>
          </div>
        </div>
      </div>
      <div class="chat-tools">
        <input id="chat-search" placeholder="Search chat history..." autocomplete="off" />
        <button id="chat-search-btn" type="button">Search</button>
        <button id="chat-search-clear" type="button">Clear</button>
        <button id="popout-chat-btn" type="button" title="Pop out chat to floating window">📌 Pop Out</button>
      </div>
      <div id="chat-search-results" class="search-results hidden" aria-live="polite"></div>
      <div id="chat-window"></div>
      <form id="chat-form">
        <input id="chat-input" placeholder="Teach Pal…" autocomplete="off" />
        <button type="submit">Send</button>
      </form>
    </section>

    <section id="tab-stats" class="tab">
      <div class="pal-advancement-card">
        <h3>Pal Advancement</h3>
        <div class="advancement-content">
          <div class="advancement-info">
            <div class="advancement-row">
              <span class="advancement-label">Current Level</span>
              <span class="advancement-value" id="advancement-level">0</span>
            </div>
            <div class="advancement-row">
              <span class="advancement-label">Experience Points</span>
              <span class="advancement-value" id="advancement-xp">0 / 100</span>
            </div>
            <div class="advancement-row">
              <span class="advancement-label">XP to Next Level</span>
              <span class="advancement-value highlight" id="advancement-remaining">100</span>
            </div>
          </div>
          <div class="advancement-progress">
            <div class="progress-bar-container">
              <div class="progress-bar-fill" id="advancement-progress-bar" style="width: 0%"></div>
              <div class="progress-bar-text" id="advancement-progress-text">0%</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-box">
          <div>Level</div>
          <div id="stat-level">0</div>
        </div>
        <div class="stat-box">
          <div>XP</div>
          <div id="stat-xp">0</div>
        </div>
        <div class="stat-box">
          <div>CP</div>
          <div id="stat-cp">0</div>
        </div>
        <div class="stat-box">
          <div>Vocabulary</div>
          <div id="stat-vocab">0</div>
        </div>
      </div>
      
      <div class="current-emotion-card">
        <h3>Current Emotional State</h3>
        <div class="emotion-display-large">
          <div class="emotion-icon-large" id="stat-emotion-icon">😊</div>
          <div class="emotion-info">
            <div class="emotion-label">Mood</div>
            <div class="emotion-value" id="stat-emotion-mood">Calm</div>
            <div class="emotion-label">Intensity</div>
            <div class="emotion-bar-large">
              <div class="emotion-fill" id="stat-emotion-fill" style="width: 50%"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="progress-dashboard">
        <div class="chart-card">
          <h3>XP Over Time</h3>
          <canvas id="xpChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <h3>Conversations per Day</h3>
          <canvas id="convoChart" height="200"></canvas>
        </div>
      </div>
      
      <canvas id="personalityChart" width="400" height="400"></canvas>
    </section>

    <section id="tab-brain" class="tab">
      <div class="brain-tabs">
        <button type="button" data-brain-tab="concepts" class="brain-tab-btn active">Concepts</button>
        <button type="button" data-brain-tab="neural" class="brain-tab-btn">Neural Activity</button>
      </div>
      
      <!-- Concepts Sub-Tab (existing brain graph) -->
      <div id="brain-tab-concepts" class="brain-tab-content active">
        <div class="brain-toolbar">
          <button id="refresh-brain" type="button">Refresh Graph</button>
          <span id="brain-summary">Nodes: 0 · Links: 0 · Memories: 0</span>
        </div>
        <div class="brain-layout">
          <div class="brain-graph-card">
            <div id="brain-graph"></div>
          </div>
          <aside class="brain-sidebar">
            <div class="brain-info">
              <h3>How to read this graph</h3>
              <p id="brain-description">Nodes represent the words and concepts Pal hears most often. Links connect words that commonly appear together.</p>
              <ul>
                <li><strong>Size</strong>: frequency of the word.</li>
                <li><strong>Color</strong>: interaction recency.</li>
                <li><strong>Edges</strong>: shared context strength.</li>
              </ul>
            </div>
            <div class="brain-memories">
              <div class="brain-memories-header">
                <h3>Recent Memories <span class="help-icon" title="Memories are important interactions stored by Pal. Click on a memory to see Pal's subjective perspective of how it felt during that moment. Sentiment shows emotional tone, keywords show main concepts.">ⓘ</span></h3>
              </div>
              <div id="memory-list" class="memory-list"></div>
            </div>
          </aside>
        </div>
      </div>
      
      <!-- Neural Activity Sub-Tab (NEW) -->
      <div id="brain-tab-neural" class="brain-tab-content">
        <div class="neural-toolbar">
          <button id="refresh-neural" type="button">Refresh</button>
          <span id="neural-summary">Neurons: 0 · Regions: 7 · Firings: 0</span>
        </div>
        <div class="neural-container">
          <div class="neural-visualization">
            <svg id="neural-canvas" viewBox="0 0 700 700"></svg>
          </div>
          <aside class="neural-sidebar">
            <div class="neural-info">
              <h3>Neural Network</h3>
              <p>Watch Pal's brain regions fire in real-time as thoughts are processed.</p>
              <div class="region-legend">
                <h4>Brain Regions</h4>
                <div class="legend-item">
                  <span class="legend-color" style="background: #64b5f6"></span>
                  <span>Sensory Input</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #9c27b0"></span>
                  <span>Language Center</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #66bb6a"></span>
                  <span>Association Cortex</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #5b6fd8"></span>
                  <span>Frontal Lobe</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #e91e63"></span>
                  <span>Amygdala</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #ff9800"></span>
                  <span>Memory Systems</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #00bcd4"></span>
                  <span>Motor Output</span>
                </div>
              </div>
            </div>
            <div class="neural-stats">
              <h4>Network Stats</h4>
              <div class="stat-row">
                <span>Total Neurons:</span>
                <span id="neural-total">0</span>
              </div>
              <div class="stat-row">
                <span>Total Firings:</span>
                <span id="neural-firings">0</span>
              </div>
              <div class="stat-row">
                <span>Most Active:</span>
                <span id="neural-most-active">—</span>
              </div>
              <button id="regenerate-neural" class="neural-action-btn" type="button">🧠 Regenerate Neural Network</button>
            </div>
            <div class="neural-events">
              <h4>Recent Activity</h4>
              <div id="neural-event-list" class="event-list"></div>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <section id="tab-journal" class="tab">
      <div class="journal-toolbar">
        <div class="brain-tabs">
          <button class="brain-tab-btn active" data-journal-tab="thoughts" type="button">Thoughts</button>
          <button class="brain-tab-btn" data-journal-tab="ideas" type="button">Ideas</button>
          <button class="brain-tab-btn" data-journal-tab="personality" type="button">Personality</button>
          <button class="brain-tab-btn" data-journal-tab="people" type="button">People</button>
          <button class="brain-tab-btn" data-journal-tab="interests" type="button">Interests</button>
        </div>
        <button id="refresh-journal" type="button">Refresh</button>
        <span id="journal-summary">Thoughts: 0</span>
        <span class="help-icon" title="Journal shows Pal's internal thought process, ideas, personality traits, people it knows, and topics of interest.">ⓘ</span>
      </div>
      
      <div id="journal-tab-thoughts" class="brain-tab-content active">
        <div id="journal-entries" class="journal-list"></div>
      </div>
      
      <div id="journal-tab-ideas" class="brain-tab-content">
        <div id="journal-ideas" class="journal-list">
          <p class="memory-empty">Ideas and insights Pal has formed will appear here...</p>
        </div>
      </div>
      
      <div id="journal-tab-personality" class="brain-tab-content">
        <div id="journal-personality" class="journal-list">
          <p class="memory-empty">Personality traits and characteristics will appear here...</p>
        </div>
      </div>
      
      <div id="journal-tab-people" class="brain-tab-content">
        <div id="journal-people" class="journal-list">
          <p class="memory-empty">People Pal knows about will appear here...</p>
        </div>
      </div>
      
      <div id="journal-tab-interests" class="brain-tab-content">
        <div id="journal-interests" class="journal-list">
          <p class="memory-empty">Topics and interests Pal has developed will appear here...</p>
        </div>
      </div>
    </section>

    <section id="tab-settings" class="tab">
      <div class="settings-container">
        <h2>Settings</h2>
        
        <div class="settings-section">
          <h3>Appearance</h3>
          <label>
            <span>Theme</span>
            <select id="theme-select">
              <option value="dark">Dark (Default)</option>
              <option value="midnight">Midnight Blue</option>
              <option value="ocean">Ocean</option>
              <option value="forest">Forest</option>
              <option value="sunset">Sunset</option>
            </select>
          </label>
          <label>
            <span>Font Family</span>
            <select id="font-select">
              <option value="system-ui">System Default</option>
              <option value="'Segoe UI', sans-serif">Segoe UI</option>
              <option value="'Roboto', sans-serif">Roboto</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Fira Code', monospace">Fira Code (Mono)</option>
              <option value="'Courier New', monospace">Courier New</option>
            </select>
          </label>
          <label class="slider-group">
            <span>Text Size</span>
            <input id="text-size" type="range" min="12" max="20" value="16" step="1" />
            <span id="text-size-value">16px</span>
          </label>
          <label class="checkbox-label">
            <input id="smooth-scrolling" type="checkbox" checked />
            <span>Smooth Scrolling</span>
          </label>
          <label class="checkbox-label">
            <input id="reduced-motion" type="checkbox" />
            <span>Reduce Animations</span>
          </label>
          <p class="help-text">Customize the look and feel of MyPal to your preference.</p>
        </div>

        <div class="settings-section">
          <h3>Learning & Development</h3>
          <label class="slider-group">
            <span>Learning Speed Multiplier</span>
            <input id="xp-multiplier" type="range" min="1" max="250" value="1" />
            <span id="xp-multiplier-value">1x</span>
          </label>
          <p class="help-text">Controls how quickly Pal gains XP and levels up. Higher values = faster development.</p>
        </div>

        <div class="settings-section">
          <h3>AI Provider</h3>
          <label>
            <span>Provider</span>
            <select id="api-provider">
              <option value="local">Local Only (default)</option>
              <option value="openai">OpenAI</option>
              <option value="azure">Azure OpenAI</option>
              <option value="gemini">Google Gemini</option>
            </select>
          </label>
          <label>
            <span>API Key</span>
            <input id="api-key" type="password" placeholder="Optional — stored locally" />
          </label>
          <p class="help-text">Optional: Configure external AI provider for enhanced responses at higher levels.</p>
        </div>

        <div class="settings-section">
          <h3>Privacy & Security</h3>
          <label class="checkbox-label">
            <input id="telemetry" type="checkbox" />
            <span>Enable Telemetry (opt-in)</span>
          </label>
          <label class="checkbox-label">
            <input id="auth-required" type="checkbox" />
            <span>Require login for sensitive actions</span>
          </label>
          <p class="help-text">Telemetry helps improve MyPal. All data stays local unless explicitly enabled.</p>
        </div>

        <div class="settings-section">
          <h3>Profile Management</h3>
          <div class="settings-actions">
            <button id="switch-profile" class="secondary">Switch Profile</button>
          </div>
          <p class="help-text">Return to profile selection menu to switch between your Pals.</p>
        </div>

        <div class="settings-section">
          <h3>Actions</h3>
          <div class="settings-actions">
            <button id="save-settings" class="primary">Save Settings</button>
            <button id="export-memory">Export Memory</button>
            <button id="reset-pal" class="danger">Reset Pal</button>
          </div>
          <p class="help-text danger-text">⚠️ Reset Pal will permanently delete all data, conversations, and progress.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <small>Stage 0–1 MVP — Local prototype</small>
  </footer>

  <!-- Connectivity/status modal -->
  <div id="status-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="status-title">
    <div class="modal-card">
      <h2 id="status-title">Backend Not Reachable</h2>
      <p>
        The local server at <code>http://localhost:3001</code> is not responding.
        Please start the backend (see README) and try again.
      </p>
      <div class="modal-actions">
        <button id="retry-connection" type="button">Retry</button>
        <button id="dismiss-connection" type="button">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Neural Network Regeneration Modal -->
  <div id="neural-regen-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="neural-regen-title">
    <div class="modal-card neural-regen-card">
      <h2 id="neural-regen-title">🧠 Generating Neural Network</h2>
      <p class="neural-regen-subtitle">This may take a while...</p>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div id="neural-regen-progress" class="progress-fill" style="width: 0%"></div>
          <span id="neural-regen-percent" class="progress-text">0%</span>
        </div>
      </div>
      
      <div class="neural-regen-status">
        <div class="status-message" id="neural-regen-message">Initializing...</div>
        <div class="status-eta" id="neural-regen-eta">Calculating time remaining...</div>
      </div>
      
      <div class="neural-regen-phase">
        <span class="phase-label">Phase:</span>
        <span id="neural-regen-phase" class="phase-value">Starting</span>
      </div>
      
      <div class="modal-actions">
        <button id="neural-regen-close" class="primary" type="button" disabled>Close</button>
      </div>
    </div>
  </div>

  <!-- Floating Chat Modal -->
  <div id="floating-chat-modal" class="floating-chat-modal hidden">
    <div class="floating-chat-header">
      <span class="floating-chat-title">💬 Chat with Pal</span>
      <button id="close-floating-chat" class="close-floating-btn" type="button" title="Close floating chat">✕</button>
    </div>
    <div class="floating-chat-body">
      <div class="emotion-display-mini" id="emotion-display-floating">
        <div class="emotion-icon-mini" id="emotion-icon-floating">😊</div>
        <div class="emotion-mood-mini" id="emotion-mood-floating">Pal is calm</div>
      </div>
      <div id="floating-chat-window"></div>
      <form id="floating-chat-form">
        <input id="floating-chat-input" placeholder="Type a message..." autocomplete="off" />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- Developer tools panel (toggle with Ctrl+D) -->
  <div id="dev-panel" class="dev-panel hidden">
    <div class="dev-row"><strong>Backend:</strong> <span id="dev-backend-status">unknown</span></div>
    <div class="dev-row"><strong>API Provider:</strong> <span id="dev-api-provider">local</span></div>
    <div class="dev-row"><button id="dev-ping" type="button">Ping Health</button></div>
    <div class="dev-row">
      <input id="auth-user" placeholder="username" />
      <input id="auth-pass" placeholder="password" type="password" />
      <button id="auth-register" type="button">Register</button>
      <button id="auth-login" type="button">Login</button>
      <button id="auth-logout" type="button">Logout</button>
    </div>
    <div class="dev-row"><small id="auth-status">Not logged in</small></div>
  </div>
  </div> <!-- End main-app -->

  <!-- Graph library -->
  <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
</body>
</html>
